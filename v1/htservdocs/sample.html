<!DOCTYPE html>
<html>
<head>
<script src='/js/wamp-client.js'></script>
<script src='/js/wamp-client-manager.js'></script>
<script>
/* kadecot_init argument can contain the following parameters

///////////////////////
// mandatory
///////////////////////

// callback when connected
onconnect : function(device_list,wamp){}

///////////////////////
// optional
///////////////////////

// callback when disconnected
ondisconnect : function(error_object){}


// specifies requested devices.
// each device object should contain protocol, deviceType, deviceId, and nickname.
manifest : [ {device object 1},{device object 2}, .. ]

// currently unused.
scope : "scope string"
*/

function kadecot_init(arg) {
  if (typeof arg == 'function')
    arg = {
      onconnect: arg
    };

  if (typeof arg.scope != 'string') arg.scope = 'com.sonycsl.kadecot';

  if (typeof arg.onconnect != 'function') {
    alert('kadecot_init : onconnect callback should be specified!');
    return;
  }

  if (typeof arg.ondisconnect != 'function')
    arg.ondisconnect = function() {}


  function connectLocal(host) {
    var wampClient = new WampClientManager();
    var conn, interf;
    wampClient.WampClientTransport = {
      open: function(_interf) {
        interf = _interf;
        conn = new WebSocket('ws://'+host+':41314/ws', ['wamp.2.json']);

        conn.onopen = function() {
          interf.onopen();
        };

        conn.onerror = function(error) {
          interf.onerror(error);
        };

        conn.onmessage = function(e) {
          interf.onmessage(e.data);
        };

      },
      send: function(data) {
        conn.send(data);
      },
      close: function(e) {
        interf.onclose(e);
      }
    };

    wampClient.connect(arg.scope, arg.manifest, arg.onconnect, arg.ondisconnect);

  };

  var urlVars = {};
  if (location.search.length > 0) {
    var token;
    var sharp_i = location.href.indexOf('#');
    if (sharp_i >= 0)
      token = location.href.substring(sharp_i + 1);

    var eqs = location.search.split(/[\?&]/);
    eqs.forEach(function(eq) {
      var terms = eq.split('=');
      if (terms.length < 2) return;
      urlVars[terms[0]] = terms[1];
    });
    urlVars._token = token;
  }

  connectLocal(location.hostname);
}


function log(msg){document.body.innerHTML = document.body.innerHTML + msg+'<br />';}

var wamp , aircon ;

function onset(){
	wamp.sendCall({}
		, "com.sonycsl.kadecot.echonetlite.procedure.HomeAirConditioner.set"
		, [aircon.deviceId], {"propertyName":"OperationStatus","propertyValue":[0x30]}
		, function(ret) {
			log(JSON.stringify(ret)) ;
	        });
}

function onget(){
	wamp.sendCall({}
		, "com.sonycsl.kadecot.echonetlite.procedure.HomeAirConditioner.get"
		, [aircon.deviceId], {"propertyName":"OperationStatus"}
		, function(ret) {
			log(JSON.stringify(ret)) ;
	        });
}

onload = function(){
	kadecot_init(function(devlist,_wamp){
		console.log(devlist);
		wamp = _wamp ;
		devlist.forEach(function(dev){
			if( dev.protocol !== 'echonetlite' || dev.deviceType !== 'HomeAirConditioner') return ;
			aircon = dev ;

			log('Air-conditoner found.') ;

			wamp.sendSubscribe({},"com.sonycsl.kadecot.echonetlite.topic.HomeAirConditioner.OperationStatus"
				,function(r){log('Value changed : '+JSON.stringify(r));}
				,function(){log('Subscribed : '+JSON.stringify(arguments));}
			);
			return ;
		}) ;
	}) ;
}
</script>
</head>
<body>
<input type='button' onclick='onset();' value='set'></input> <input type='button' onclick='onget();' value='get'></input><br />
<hr />
</body>
</html>
