<!DOCTYPE html> 
<html>
<head>
<script src='/js/kadecot.m.js'></script>
<script>

onload = function(){

///////////////////////
// usage example
///////////////////////

// Initialization
kadecot_init({
	// [Optional]
	// realm is 'v1' for Linux Kadecot (which is the default)
	// , while  'default' for Android Kadecot.
	// Android Kadecot requires local OAuth. To do that, the webapp must be hosted under a web server.
	realm : 'v1'

	// [Optional] host name or IP address string of the Kadecot server to connect to.
	// host parameter is NOT necessary when the address is supplied as the URL argument k.
	// (Eg. http://a.b.c.d/test?k=KadecotIP)
	,host : location.hostname

}).then( function(re){
	log(re.devices) ;	// devices list

	re.devices.forEach( function(device){
		if( device.protocol == 'echonetlite' && device.deviceType == 'HomeAirConditioner' ){
			// Air-conditioner found

			// Use PubSub to monitor Air-conditioner power change
			device.sub(
				// A string called 'Topic'.
				// Check available topics on http://app.kadecot.net/docs/ProcTopic/
				'com.sonycsl.kadecot.echonetlite.topic.HomeAirConditioner.OperationStatus'

				// Callback function on property change
				, function (newval) {
					log( 'HomeAirConditioner power changed:' ) ;
					log( newval ) ;
				}
			)
			// Optionally set success callback
			.then( function(){ log( 'Successfully subscribed' ) ; } ) ;

			// Use of RPC (command send/information get on demand)
			// Send power on signal after 5 seconds. (it is desirable to take sufficient time between calls)
			setTimeout( function(){
				device.rpc(
					// A string called 'Procedure'. 
					// Check available procedures on http://app.kadecot.net/docs/ProcTopic/
					'com.sonycsl.kadecot.echonetlite.procedure.HomeAirConditioner.set'

					// Procedure-dependent parameter.
					,{"propertyName":"OperationStatus","propertyValue":[0x30]}
				)
				// Optionally set call result callback
				.then( log ) ;
			},5000 ) ;
		}
	} ) ;

} ) ;

} ;

/*

///////////////////////
///////////////////////
// Parameters for kadecot_init()
///////////////////////
///////////////////////

///////////////////////
// mandatory
///////////////////////

realm : 'v1' (Linux version) or 'default' (Android version)

///////////////////////
// optional
///////////////////////

host : String of local Kadecot IP address.
Not necessary when the address is supplied as the URL argument k.
(Eg. http://a.b.c.d/test?k=KadecotIP)

///////////////////////
// currently unused
///////////////////////

scope : "scope string"
// Required permission of the application

manifest: [ {device object 1},{device object 2}, .. ]
// List of required devices.
// each device object should contain protocol, deviceType, deviceId, and nickname.

*/

function log(text){
	var ele = document.createElement("hr");
	var str = document.createTextNode( typeof text == 'string' ? text : JSON.stringify(text) );
	ele.appendChild(str);

	document.body.appendChild(ele);
}

</script>
</head>
<body>
</body>
</html>