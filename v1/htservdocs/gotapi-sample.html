<!DOCTYPE html>
<html>

<head>
  <script src='/js/wamp-client.js'></script>
  <script src='/js/wamp-client-manager.js'></script>
  <script>
  function kadecot_init (callback) {
    var args = {
      scope: 'com.sonycsl.kadecot',
      onconnect: callback,
      ondisconnect: function () {}
    };

    function connectLocal(host) {
      var wampClient = new WampClientManager();
      var conn, interf;

      wampClient.WampClientTransport = {
        open: function(_interf) {
          interf = _interf;
          conn = new WebSocket('ws://' + host + ':41314/ws', ['wamp.2.json']);
          conn.onopen = interf.onopen.bind(interf);
          conn.onerror = interf.onerror.bind(interf);
          conn.onmessage = function (ev) {
            interf.onmessage(ev.data);
          };
        },
        send: conn.send.bind(conn),
        close: interf.onclose.bind(interf)
      };
      wampClient.connect(args.scope, args.manifest, args.onconnect, args.ondisconnect);
    }

    connectLocal(location.hostname);
  }


  function log(msg){
    var pre = document.createElement('pre');
    pre.textContent = msg;
    document.body.appendChild(pre);
  }

  var wamp;

  window.addEventListener('load', function () {
    kadecot_init(function (devlist, _wamp) {
      console.log(devlist);
      wamp = _wamp;
      var gotapi = devlist.filter((d) => d.protocol === 'gotapi' && d.deviceType === 'GotAPIManager')[0];
      wamp.sendCall(
        {},
        "gotapi.procedure.servicediscovery.get",
        [ gotapi.deviceId ],
        {},
        function (ret) {
          log(JSON.stringify(ret[4], null, 2)) ;
        }
      );
    });
  });
  </script>
</head>

<body>
</body>

</html>
